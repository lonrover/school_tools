<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>经费流水</title>

<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Excel 库 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>

<div class="layout">

  <!-- 左侧菜单 -->
  <div class="sidebar">
    <div class="logo">
      <i class="fas fa-flask"></i>
      <span>实验室管理</span>
    </div>

    <ul class="menu">
      <li class="menu-item">
        <a href="ledger.html"><i class="fas fa-book"></i> 实验室台账</a>
      </li>
      <li class="menu-item">
        <a href="assets.html"><i class="fas fa-boxes"></i> 资产明细</a>
      </li>
      <li class="menu-item">
        <a href="usage.html"><i class="fas fa-chalkboard-teacher"></i> 使用记录</a>
      </li>
      <li class="menu-item">
        <a href="consume.html"><i class="fas fa-vials"></i> 耗材管理</a>
      </li>
      <li class="menu-item active">
        <a href="cash.html"><i class="fas fa-yen-sign"></i> 经费流水</a>
      </li>
    </ul>
  </div>

  <!-- 主内容 -->
  <div class="main-content">

    <div class="page-header">
      <h2>经费流水</h2>
    </div>

    <div class="card">

      <!-- 操作按钮（完全一致） -->
      <button class="primary" onclick="openForm()">
        <i class="fas fa-plus"></i> 新增记录
      </button>

      <button class="success" onclick="exportData()">
        <i class="fas fa-file-excel"></i> 导出数据
      </button>

      <button class="success" onclick="exportTemplate()">
        <i class="fas fa-file"></i> 导出模板
      </button>

      <button class="success" onclick="document.getElementById('file').click()">
        <i class="fas fa-file-import"></i> 导入 Excel
      </button>

      <input type="file" id="file" accept=".xlsx,.xls"
             style="display:none"
             onchange="importExcelFile(this.files[0])">

      <!-- 表格 -->
      <table style="margin-top:15px">
        <thead>
          <tr>
            <th>日期</th>
            <th>项目</th>
            <th>类型</th>
            <th>金额</th>
            <th>经办人</th>
            <th>备注</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>

    </div>
  </div>
</div>

<!-- 弹窗 -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 style="margin-bottom:15px">经费流水</h3>

    <div class="form-panel">
      <input id="f0" placeholder="日期">
      <input id="f1" placeholder="项目">
      <input id="f2" placeholder="类型（收入 / 支出）">
      <input id="f3" placeholder="金额">
      <input id="f4" placeholder="经办人">
      <input id="f5" placeholder="备注">
    </div>

    <div style="text-align:right;margin-top:10px">
      <button class="danger" onclick="closeForm()">取消</button>
      <button class="success" onclick="save()">保存</button>
    </div>
  </div>
</div>

<script>
/************************
 * 文件型数据库 API
 ************************/
async function apiGet(){
  const res = await fetch('/api/cash')
  return await res.json()
}

async function apiSet(data){
  await fetch('/api/cash',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  })
}

/************************
 * 页面逻辑
 ************************/
let editIndex = null

async function render(){
  const data = await apiGet()
  document.getElementById('body').innerHTML = data.map((r,i)=>`
    <tr>
      <td>${r[0]}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td>
        <i class="fas fa-edit action-btn" onclick="edit(${i})"></i>
        <i class="fas fa-trash action-btn delete" onclick="del(${i})"></i>
      </td>
    </tr>
  `).join('')
}

function openForm(){
  editIndex = null
  document.querySelectorAll('.form-panel input').forEach(i=>i.value='')
  modal.style.display='flex'
}

function closeForm(){
  modal.style.display='none'
}

async function save(){
  const values = [...document.querySelectorAll('.form-panel input')].map(i=>i.value)
  const data = await apiGet()
  editIndex === null ? data.push(values) : data[editIndex] = values
  await apiSet(data)
  closeForm()
  render()
}

async function edit(i){
  editIndex = i
  const data = await apiGet()
  data[i].forEach((v,idx)=>f0.parentNode.children[idx].value=v)
  modal.style.display='flex'
}

async function del(i){
  if(confirm('确定删除该记录？')){
    const data = await apiGet()
    data.splice(i,1)
    await apiSet(data)
    render()
  }
}

/************************
 * Excel 导出（数据）
 ************************/
async function exportData(){
  const data = await apiGet()
  const wb = XLSX.utils.book_new()
  const ws = XLSX.utils.aoa_to_sheet([
    ['日期','项目','类型','金额','经办人','备注'],
    ...data
  ])
  XLSX.utils.book_append_sheet(wb, ws, '经费流水')
  XLSX.writeFile(wb, '经费流水.xlsx')
}

/************************
 * Excel 导出（模板）
 ************************/
function exportTemplate(){
  const wb = XLSX.utils.book_new()
  const ws = XLSX.utils.aoa_to_sheet([
    ['日期','项目','类型','金额','经办人','备注']
  ])
  XLSX.utils.book_append_sheet(wb, ws, '模板')
  XLSX.writeFile(wb, '经费流水_导入模板.xlsx')
}

/************************
 * Excel 导入
 ************************/
function importExcelFile(file){
  const reader = new FileReader()
  reader.onload = async e=>{
    const wb = XLSX.read(e.target.result,{type:'binary'})
    const ws = wb.Sheets[wb.SheetNames[0]]
    const rows = XLSX.utils.sheet_to_json(ws,{header:1})
    rows.shift()
    await apiSet(rows.filter(r=>r.length>=6))
    render()
  }
  reader.readAsBinaryString(file)
}

/* 初始化 */
render()
</script>

</body>
</html>
